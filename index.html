<!-- microdata and workers -->

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>

		<link rel="stylesheet" href="/styles.css" />

		<script
			type="module"
			src="https://unpkg.com/es-module-shims@1.6.2/dist/es-module-shims.js?module"></script>

		<script defer src="/matrix-3D.js"></script>

		<script type="module">
			/////////////////////////////////////////////

			class Rectangle extends DOMRect {
				static fromDOMRect({ top, right, bottom, left }) {
					return new Rectangle(top, right, bottm, left)
				}

				intersection(other) {
					const top = Math.max(this.top, other.top)
					const right = Math.min(this.right, other.right)
					const bottom = Math.min(this.bottom, other.bottom)
					const left = Math.max(this.left, other.left)

					if (top >= bottom || left >= right) throw TypeError()

					return new Rectangle(top, right, bottom, left)
				}

				to8() {
					return [
						this.top,
						this.left,
						this.top,
						this.right,
						this.bottom,
						this.right,
						this.bottom,
						this.left,
					]
				}

				calculateCut(other) {
					const thisWidth = this.right - this.left
					const thisHeight = this.bottom - this.top
					const otherWidth = other.right - other.left
					const otherHeight = other.bottom - other.top

					// return (
					// 	Math.min(thisWidth) *
					// 		(Math.max(otherHeight) / Math.max(thisWidth)) -
					// 	Math.min(otherWidth)
					// )

					const thisAspectRatio = thisWidth / thisHeight
					const otherAspectRatio = otherWidth / otherHeight

					if (thisAspectRatio > otherAspectRatio) {
						return (
							thisWidth * (otherHeight / thisHeight) - otherWidth
						)
					} else {
						return -(
							thisHeight * (otherWidth / thisWidth) -
							otherHeight
						)
					}
				}
			}

			const IS_IOS = 'requestPermission' in DeviceMotionEvent

			const SCREEN_RECTANGLE = new Rectangle(
				0,
				innerWidth,
				innerHeight,
				0,
			)

			async function requestIOSPermissions() {
				await DeviceMotionEvent.requestPermission()
			}

			async function requestPermissions() {
				;['granted', 'prompt'].includes(
					(
						await navigator.permissions.query({
							name: 'gyroscope',
						})
					).state,
				)
			}

			try {
				// VIDEO
				const main = document.querySelector('main')
				const mainContent = main.querySelector('div')

				const video = document.createElement('video')
				const mediaStream = await navigator.mediaDevices.getUserMedia({
					video: {
						// facingMode: { exact: 'environment' },
						facingMode: 'environment',
					},
				})

				video.autoplay = true
				video.playsInline = true
				video.srcObject = mediaStream

				// If I change the to `append` it'll zoom the video!?!?
				document.body.prepend(video)

				document.body.classList.add('AR')

				await new Promise((resolve) => {
					video.addEventListener('loadeddata', () => resolve())
				})

				// COME FROM QR CODE
				const { default: QrScanner } = await import(
					'https://unpkg.com/qr-scanner@1.4.1/qr-scanner.min.js'
				)

				const QRScannerScanImageOptions = {
					// scanRegion: {
					// 	x: 0,
					// 	y: 0,
					// 	height: SCREEN_RECTANGLE.height,
					// 	width: SCREEN_RECTANGLE.width,
					// },
					qrEngine: QrScanner.createQrEngine(QrScanner.WORKER_PATH),
					canvas: document.createElement('canvas'),
				}

				const iOSNote = document.querySelector('#iOS-note')
				const iOSNoteButton = iOSNote.querySelector('form > button')
				const note = document.querySelector('#note')

				if (IS_IOS) {
					iOSNote.show()
				} else {
					await requestPermissions()
					note.show()
				}

				const boundingClientRect = mainContent.getBoundingClientRect()

				async function eventLoop() {
					try {
						const { cornerPoints } = await QrScanner.scanImage(
							video,
							QRScannerScanImageOptions,
						)

						const videoRectangle = new Rectangle(
							0,
							0,
							video.videoWidth,
							video.videoHeight,
						)
						const videoContainerRectangle = new Rectangle(
							0,
							0,
							video.clientWidth,
							video.clientHeight,
						)
						const cut = videoRectangle.calculateCut(
							videoContainerRectangle,
						)

						document.body.style.setProperty(
							'--translate',
							`-${boundingClientRect.x + Math.abs(cut)}px -${
								boundingClientRect.y + Math.abs(cut)
							}px`,
						)

						let scale
						let scale2

						if (cut < 0) {
							// height cut
							scale =
								videoContainerRectangle.width /
								videoRectangle.width

							scale2 =
								videoContainerRectangle.height /
								videoRectangle.height
						} else {
							// width cut
							scale =
								videoContainerRectangle.height /
								videoRectangle.height

							scale2 =
								videoContainerRectangle.width /
								videoRectangle.width
						}

						let corners = [
							cornerPoints[0].x,
							cornerPoints[0].y,
							cornerPoints[1].x,
							cornerPoints[1].y,
							cornerPoints[3].x,
							cornerPoints[3].y,
							cornerPoints[2].x,
							cornerPoints[2].y,
						]

						corners = corners.map((c) => c * scale)

						if (cut < 0) {
							corners = corners.map((c, i) =>
								i % 2 ? c - Math.abs(cut) / 2 : c,
							)
						} else {
							// width cut
							corners = corners.map((c, i) =>
								i % 2 ? c : c - Math.abs(cut) / 2,
							)
						}

						transform2d(mainContent, ...corners)
					} catch (error) {
						if (error !== 'No QR code found') throw error
					}

					requestAnimationFrame(eventLoop)
				}

				await eventLoop()

				// const { cornerPoints } = await new Promise(async (resolve) => {
				// 	let currentResult = null
				// 	let resolved = false

				// 	iOSNoteButton.addEventListener('click', async () => {
				// 		await requestIOSPermissions()
				// 		resolve(currentResult)
				// 		resolved = true
				// 	})

				// 	async function eventLoop() {
				// 		try {
				// 			// TODO(ayoreis) don't create engine and canvas when `BarcodeDetector` is available
				// 			currentResult = await QrScanner.scanImage(
				// 				video,
				// 				QRScannerScanImageOptions,
				// 			)

				// 			if (IS_IOS) {
				// 				iOSNoteButton.disabled = false
				// 				!resolved && requestAnimationFrame(eventLoop)
				// 			} else {
				// 				note.close()
				// 				resolve(currentResult)
				// 			}
				// 		} catch (error) {
				// 			if (error !== 'No QR code found') throw error
				// 			iOSNoteButton.disabled = true
				// 			requestAnimationFrame(eventLoop)
				// 		}
				// 	}

				// 	await eventLoop()
				// })

				// const boundingClientRect = mainContent.getBoundingClientRect()

				// document.body.style.setProperty(
				// 	'--translate',
				// 	`-${boundingClientRect.x}px -${boundingClientRect.y}px`,
				// )

				// // document.body.style.setProperty('--transform')

				// const xRatio = video.clientHeight / video.videoHeight
				// const yRatio = video.clientWidth / video.videoWidth

				// const corners = [
				// 	cornerPoints[0].x * xRatio,
				// 	cornerPoints[0].y * yRatio,
				// 	cornerPoints[1].x * xRatio,
				// 	cornerPoints[1].y * yRatio,
				// 	cornerPoints[3].x * xRatio,
				// 	cornerPoints[3].y * yRatio,
				// 	cornerPoints[2].x * xRatio,
				// 	cornerPoints[2].y * yRatio,
				// ]

				// transform2d(mainContent, ...corners)

				// MOTION
				const { Gyroscope } = await import(
					'https://unpkg.com/motion-sensors-polyfill@0.3.7/src/motion-sensors.js'
				)

				const gyroscope = new Gyroscope({
					frequency: 10,
					referenceFrame: 'device',
				})

				gyroscope.addEventListener(
					'reading',
					({ currentTarget: { x, y } }) => {
						const allClasses = ['top', 'bottom', 'left', 'right']
						const addedClasses = new Set()

						if (x > 1) {
							addedClasses.add('top')
						} else if (x < -1) {
							addedClasses.add('bottom')
						}

						if (y > 1) {
							addedClasses.add('left')
						} else if (y < -1) {
							addedClasses.add('right')
						}

						for (const oneClass of allClasses) {
							if (addedClasses.has(oneClass)) {
								document.body.classList.add(oneClass)
							} else {
								document.body.classList.remove(oneClass)
							}
						}
					},
				)

				// gyroscope.start()
			} catch (error) {
				console.error(error)
				document.body.classList.remove('AR')
			}

			document.body.classList.add('ready')
		</script>
	</head>

	<body>
		<main>
			<!-- <video></video> -->

			<dialog id="iOS-note">
				<form method="dialog">
					<button disabled>
						Point at the QR code, then click here
					</button>
				</form>
			</dialog>

			<dialog id="note">
				<p>Point at the QR code</p>
			</dialog>

			<div>
				<h1>Lorem, ipsum.</h1>

				<p>
					Lorem ipsum dolor sit amet consectetur adipisicing elit.
					Optio aperiam, similique quidem molestiae recusandae dolorum
					commodi nihil, officiis blanditiis unde, voluptatibus facere
					debitis assumenda ut. Libero velit officia ipsa pariatur
					impedit a repudiandae possimus, tempora dolores excepturi,
					provident aperiam dicta voluptate ducimus atque, placeat
					illo. Ipsum dolore ipsam ullam, obcaecati laudantium quis
					ratione, doloremque neque repellendus, accusantium esse?
					Quisquam excepturi quas numquam consectetur, rerum voluptate
					ad perspiciatis quibusdam accusamus, temporibus esse sequi
					sit recusandae voluptatem iusto odit voluptas deleniti
					expedita facere, blanditiis facilis? Voluptates, laudantium
					ducimus numquam et cupiditate tempore quae accusantium
					doloribus repellat obcaecati recusandae veritatis? Enim,
					optio ipsa?
				</p>
			</div>
		</main>
	</body>
</html>
